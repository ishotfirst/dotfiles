#!/bin/bash

NAIAD_DEVEL=$(cat ~/.naiad/.devel)
NAIAD_LOCAL=$(cat ~/.naiad/.local)

NAIAD_LOCAL_DIRECTORY=$(pwd)
NAIAD_REMOTE_DIRECTORY=$(pwd | sed -e "s|$HOME|~|")
NAIAD_CLIENT_JS_DIRECTORY='~/src/naiad.client.js'

NAIAD_INSTALL='kitty install -r .'
POST_INSTALL_COMMAND=''

IP_ADDRESS=$(/sbin/ifconfig | grep -v 127.0.0.1 |grep inet\ | tail -1 | cut -d: -f2 | awk '{ print $2}')

# if [[ ! "$NAIAD_REMOTE_DIRECTORY" =~ '~/src' ]]; then
#   echo "Not in ~/src. Nothing to do here!"
#   exit 1
# fi

# if [[ $IP_ADDRESS != 207* ]]; then
#   if $NAIAD_LOCAL; then
#     echo "Not connected to FCI. Nothing to do here!"
#     exit 1
#   fi
# fi

LIST=""

# Copy the .serial file to devel.
[ -f ".serial" ] && push .serial

# Copy the Makefiles to devel too.
# [ -f "Makefile" ] && push Makefile

# Am I installing specific files or all of them
if [[ $1 ]]; then
  LIST=("$@")

  for FILE in $LIST; do
    FILE_NAME=${FILE%.*}
    FILE_EXTENSION=${FILE##*.}

    case $FILE_EXTENSION in

      # PHP and INC files.
      php|inc)
        php -l $FILE || exit $?
        ;;

      # JavaScript
      js)
        if [[ $NAIAD_REMOTE_DIRECTORY =~ $NAIAD_CLIENT_JS_DIRECTORY ]]; then
          grunt --no-color --debug-only

          eval DIR=$NAIAD_CLIENT_JS_DIRECTORY/dist

          NAIAD_LOCAL_DIRECTORY=$DIR
          NAIAD_REMOTE_DIRECTORY=$(echo $DIR | sed -e "s|$HOME|~|")

          # Add the clients to the install list
          LIST+=( `ls $DIR | grep debug` )

          # Remove the original file
          LIST=( ${LIST[@]/$FILE/} )

        fi
        ;;

    esac
  done
  NAIAD_INSTALL="kitty install ${LIST[@]}"
else
  if [[ $NAIAD_REMOTE_DIRECTORY =~ '~/src/naiad.client.js' ]]; then
    grunt
    eval DIR=$NAIAD_CLIENT_JS_DIRECTORY/dist

    NAIAD_LOCAL_DIRECTORY=$DIR
    NAIAD_REMOTE_DIRECTORY=$(echo $DIR | sed -e "s|$HOME|~|")

  fi
fi

if $NAIAD_LOCAL; then
  echo "Using $NAIAD_DEVEL"
  remote "mkdir -p $NAIAD_REMOTE_DIRECTORY" >/dev/null
fi

# Push all the files to devel.
cd $NAIAD_LOCAL_DIRECTORY; push "${LIST[@]}"

# Remove any errant Makefiles that may have gotten added to the list
LIST=( ${LIST[@]/Makefile/} )

# Use remote to install the files if I'm not on a TDS
if $NAIAD_LOCAL; then
  remote "cd $NAIAD_REMOTE_DIRECTORY; $NAIAD_INSTALL"
else
  eval $NAIAD_INSTALL
fi

eval $POST_INSTALL_COMMAND
